# Router Log Configurations

As Choreo Connect uses an Envoy proxy as the Router component, it only supports the logging mechanisms provided by the Envoy proxy ([read more details about router]({{base_path}}/deploy-and-publish/deploy-on-gateway/choreo-connect/getting-started/choreo-connect-overview/#router)). In the following sections, you may find how to enable Router access logs and debug logs.

## Router Access Logging

You can enable Router access logs by using the following configs. Router access logs related configurations are in the `log_config.toml` file, which is located in [these directories]({{base_path}}/deploy-and-publish/deploy-on-gateway/choreo-connect/configurations/configure-logs-overview/#log_config_toml) based on your Choreo Connect deployment method.

```toml tab="Format"
[accessLogs]
enable = <true or false>
logfile = <file_path> # This file will be created inside router container.
format = <format_string>
```

```toml tab="Example"
[accessLogs]
enable = true
logfile = "/tmp/envoy.access.log"
format = "[%START_TIME%] '%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%' %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% '%REQ(X-FORWARDED-FOR)%' '%REQ(USER-AGENT)%' '%REQ(X-REQUEST-ID)%' '%REQ(:AUTHORITY)%' '%UPSTREAM_HOST%'\n"
```

Setting `enable` as `true` will let you enable the Router access logs and the file path can be set up using the `logfile`. Follow [format strings]({{envoy_path}}configuration/observability/access_log/usage#format-strings) and [command operators]({{envoy_path}}/configuration/observability/access_log/usage#command-operators) for more information on the supported options for log format, `format` configuration.

## Router debug logs

To enable Router debug logs, provide the log level as trailing arguments for the envoy command as follows.

```toml tab="Format"
-l <level>, 
--log-level <level>
--component-log-level <component>:<level>,<component>:<level>...
```

```toml tab="Example"
-l trace, 
--log-level trace
--component-log-level upstream:debug,connection:trace
```

You can do this by setting the `TRAILING_ARGS` environment variable in the Router. For example, Add the following line to the docker-compose.yaml in the directory `<CHOREO-CONNECT_HOME>/docker-compose/<choreo-connect>/`.

```yaml
  router:
    environment:
      - TRAILING_ARGS=--log-level trace
```
The following example configuration can log request headers and response headers, and `ext_authz` information.

```yaml
  router:
    environment:
      - TRAILING_ARGS=TRAILING_ARGS=--component-log-level http:debug,http2:debug,conn_handler:debug,ext_authz:trace
```
The following are different sections of an example log with the above log configuration. This log is generated by invoking an API request with `/pet/findByStatus?status=sold` path in [Swagger Petstore](https://petstore.swagger.io/) API deployed to Choreo Connect. Different log sections are given in the order same as the order in which they are logged to the console.

Client to Router request headers:
```yaml
[2022-04-11 08:18:03.917][15][debug][http] [source/common/http/conn_manager_impl.cc:867] [C19][S3973774370179828478] request headers complete (end_stream=true):
':authority', 'localhost:9095'
':path', '/v2/pet/findByStatus?status=sold'
':method', 'GET'
'user-agent', 'curl/7.68.0'
'accept', 'application/json'
'authorization', 'Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik1UWm1ZemsxWlRJeVkyTmlNR00wT1RJMFpqTXdNRE5rTldZek16QTJOVEl4TWpRelpERTFNdz09In0.eyJhdWQiOiJodHRwOlwvXC9vcmcud3NvMi5hcGltZ3RcL2dhdGV3YXkiLCJzdWIiOiJhZG1pbiIsInNjb3BlIjoicmVhZDpwZXRzIiwiaXNzIjoiaHR0cHM6XC9cL2xvY2FsaG9zdDo5MDk1XC90ZXN0a2V5Iiwia2V5dHlwZSI6IlBST0RVQ1RJT04iLCJleHAiOjE2NDk2Njg2NjUsImlhdCI6MTY0OTY2NTA2NSwianRpIjoiZDI3MTRiYmMtMWE5OC00ODc5LThmM2QtM2I5ZGYwNjI1NDcwIn0.MXkSAq98Zx32j5ijK4MLvlocMhjVW_xxW3ECeGVmHaRkqg43bO2PLtdoh952YBbK4xzK3mDhAxF1VxynDyD5u1qpu696e4w3UwF2pfU3hAdbG2fDdcm82KiSfydawOnivxFr-QX08tQxDTO9i5Fgo7nZMsZkNRN2er1asctDaDRcqcR00Jh6h1jyqBU6Ixf67dkZk61et8yNdGeSiuy-QXLVHsN8YbvXNyct1d1nVjZrE3d_kDkk_ZQlqHj327BXolCl_tiinj_bBDovmqIDNwTXkL47rtuWX6sB1uBJ0xBHtuZxT7-IgB1WUVvVcbAqNebQFs1bV8A-h0efQKKBdg'
```
Router to Enforcer request information:
```yaml
[2022-04-11 08:18:03.917][15][trace][ext_authz] [source/extensions/filters/common/ext_authz/ext_authz_grpc_impl.cc:42] Sending CheckRequest: attributes {
  source {
    address {
      socket_address {
        address: "172.18.0.1"
        port_value: 40312
      }
    }
  }
  destination {
    address {
      socket_address {
        address: "172.18.0.5"
        port_value: 9095
      }
    }
    principal: "adapter"
  }
  request {
    time {
      seconds: 1649665083
      nanos: 917501000
    }
    http {
      id: "3973774370179828478"
      method: "GET"
      headers {
        key: ":authority"
        value: "localhost:9095"
      }
      headers {
        key: ":method"
        value: "GET"
      }
      headers {
        key: ":path"
        value: "/v2/pet/findByStatus?status=sold"
      }
      headers {
        key: ":scheme"
        value: "https"
      }
      headers {
        key: "accept"
        value: "application/json"
      }
     ...
     ...
```

Enforcer to Router response information:
```yaml
[2022-04-11 08:18:03.937][15][trace][ext_authz] [source/extensions/filters/common/ext_authz/ext_authz_grpc_impl.cc:48] Received CheckResponse: status {
}
ok_response {
  headers {
    header {
      key: "X-JWT-Assertion"
      value: "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik1UWm1ZemsxWlRJeVkyTmlNR00wT1RJMFpqTXdNRE5rTldZek16QTJOVEl4TWpRelpERTFNdz09In0=.eyJzdWIiOiJhZG1pbiIsImh0dHA6XC9cL3dzbzIub3JnXC9jbGFpbXNcL2FwcGxpY2F0aW9udGllciI6IlVubGltaXRlZCIsImh0dHA6XC9cL3dzbzIub3JnXC9jbGFpbXNcL3ZlcnNpb24iOiIxLjAuNiIsImh0dHA6XC9cL3dzbzIub3JnXC9jbGFpbXNcL2tleXR5cGUiOiJQUk9EVUNUSU9OIiwiaXNzIjoid3NvMi5vcmdcL3Byb2R1Y3RzXC9hbSIsImh0dHA6XC9cL3dzbzIub3JnXC9jbGFpbXNcL2FwcGxpY2F0aW9ubmFtZSI6ImFub246TUdXIiwia2V5dHlwZSI6IlBST0RVQ1RJT04iLCJodHRwOlwvXC93c28yLm9yZ1wvY2xhaW1zXC9lbmR1c2VyVGVuYW50SWQiOiIwIiwiaHR0cDpcL1wvd3NvMi5vcmdcL2NsYWltc1wvYXBwbGljYXRpb25VVUlkIjoiNWE2YmNiMGMtZjdjMi0zYmNkLWJiMGEtMDIxZWYyMWYyMWViIiwic2NvcGUiOiJyZWFkOnBldHMiLCJleHAiOjE2NDk2NjQwODEsImh0dHA6XC9cL3dzbzIub3JnXC9jbGFpbXNcL2FwcGxpY2F0aW9uaWQiOiI1YTZiY2IwYy1mN2MyLTNiY2QtYmIwYS0wMjFlZjIxZjIxZWIiLCJodHRwOlwvXC93c28yLm9yZ1wvY2xhaW1zXC91c2VydHlwZSI6IkFwcGxpY2F0aW9uX1VzZXIiLCJpYXQiOjE2NDk2NjUwODEsImp0aSI6Ijc1NWEwYzI4LWE2ODUtNDYzNC1hNzNiLWYzOGU4NDNmODYxNyIsImh0dHA6XC9cL3dzbzIub3JnXC9jbGFpbXNcL2FwaWNvbnRleHQiOiJcL3YyIn0=.iphgEpqjBVA48rGZdv14A_iLZE81V2p0iObUGg5UPefGHDVMZoi_w2Z30oMuBpRougXoPmMWkQ_Cj4llG31d9CPW7HkQyicHup4UH1n25L4Iv3D1Pny_NhDvDmeixT3PQ_FU-1NK1tB1lxW1c4WVoRfbrIqvD5ojYx6aPy7eBNp1Hx-pZib53rd_LKkmHXH0WGW_N-vjwhlXOlCu9pANkJeRx4QWDiNvooCEgwqG2Dwgh2z8ck5XWgCVLb4Pm24Zqg0GucKfy3LTBi7uupYvDIQtUfM_HExm2OimxyCwOYDpyRGMmRqGIS2zCRq5lt8Cc3HbPpa5rxJvCXF848Aj5A=="
    }
  }
  headers {
    header {
      key: "x-wso2-cluster-header"
      value: "carbon.super_clusterProd_localhost_SwaggerPetstore1.0.6"
    }
  }
  headers {
    header {
      key: "X-TRACE-KEY"
      value: "3973774370179828478"
    }
  }
  headers_to_remove: "api_key"
  headers_to_remove: "internal-key"
}
dynamic_metadata {
  fields {
    key: "keyType"
    value {
      string_value: "PRODUCTION"
    }
  }
  fields {
    key: "token"
    value {
      string_value: "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik1UWm1ZemsxWlRJeVkyTmlNR00wT1RJMFpqTXdNRE5rTldZek16QTJOVEl4TWpRelpERTFNdz09In0.eyJhdWQiOiJodHRwOlwvXC9vcmcud3NvMi5hcGltZ3RcL2dhdGV3YXkiLCJzdWIiOiJhZG1pbiIsInNjb3BlIjoicmVhZDpwZXRzIiwiaXNzIjoiaHR0cHM6XC9cL2xvY2FsaG9zdDo5MDk1XC90ZXN0a2V5Iiwia2V5dHlwZSI6IlBST0RVQ1RJT04iLCJleHAiOjE2NDk2Njg2NjUsImlhdCI6MTY0OTY2NTA2NSwianRpIjoiZDI3MTRiYmMtMWE5OC00ODc5LThmM2QtM2I5ZGYwNjI1NDcwIn0.MXkSAq98Zx32j5ijK4MLvlocMhjVW_xxW3ECeGVmHaRkqg43bO2PLtdoh952YBbK4xzK3mDhAxF1VxynDyD5u1qpu696e4w3UwF2pfU3hAdbG2fDdcm82KiSfydawOnivxFr-QX08tQxDTO9i5Fgo7nZMsZkNRN2er1asctDaDRcqcR00Jh6h1jyqBU6Ixf67dkZk61et8yNdGeSiuy-QXLVHsN8YbvXNyct1d1nVjZrE3d_kDkk_ZQlqHj327BXolCl_tiinj_bBDovmqIDNwTXkL47rtuWX6sB1uBJ0xBHtuZxT7-IgB1WUVvVcbAqNebQFs1bV8A-h0efQKKBdg"
    }
  }
  fields {
    key: "tokenType"
    value {
      string_value: "JWT"
    }
  }
  ...
  ...
```

Router to client response headers:
```yaml
[2022-04-11 08:18:04.956][15][debug][http] [source/common/http/conn_manager_impl.cc:1467] [C19][S3973774370179828478] encoding headers via codec (end_stream=false):
':status', '200'
'date', 'Mon, 11 Apr 2022 08:18:04 GMT'
'content-type', 'application/json'
'access-control-allow-origin', '*'
'access-control-allow-methods', 'GET, POST, DELETE, PUT'
'access-control-allow-headers', 'Content-Type, api_key, Authorization'
'server', 'envoy'
'x-envoy-decorator-operation', 'localhost:^/v2/pet/findByStatus(\?([^/]+))?$'
```

Follow [command line options]({{envoy_path}}/operations/cli) for more information.

## Interceptor level debug logging

To enable interceptor level debug logging, you need to do the following configuration. 

1. Add `lua:debug` component to the `TRAILING_ARGS` like below:
```yaml
TRAILING_ARGS=--component-log-level http:debug,http2:debug,conn_handler:debug,lua:debug
```

2. Enable debug logs in `log_config.toml` file:
```toml
[debugLogs]
 enable = true
```

With the above configuration, you can get router logs with headers and body information of the requests and responses. This is helpful to identify the header/body changes occurs in request and/or response paths.
```yaml
[2022-04-11 13:29:19.539][14][debug][lua] [source/extensions/filters/http/lua/lua_filter.cc:231] resuming body due to end stream
[2022-04-11 13:29:19.539][14][debug][lua] [source/extensions/filters/http/lua/lua_filter.cc:792] script log: 
>> request before interceptors >> :authority: localhost:9095
>> request before interceptors >> :path: /book-store/v1/books
>> request before interceptors >> :method: POST
>> request before interceptors >> :scheme: https
>> request before interceptors >> user-agent: curl/7.68.0
>> request before interceptors >> accept: */*
>> request before interceptors >> authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik1UWm1ZemsxWlRJeVkyTmlNR00wT1RJMFpqTXdNRE5rTldZek16QTJOVEl4TWpRelpERTFNdz09In0.eyJhdWQiOiJodHRwOlwvXC9vcmcud3NvMi5hcGltZ3RcL2dhdGV3YXkiLCJzdWIiOiJhZG1pbiIsInNjb3BlIjoicmVhZDpwZXRzIiwiaXNzIjoiaHR0cHM6XC9cL2xvY2FsaG9zdDo5MDk1XC90ZXN0a2V5Iiwia2V5dHlwZSI6IlBST0RVQ1RJT04iLCJleHAiOjE2NDk2ODczNTcsImlhdCI6MTY0OTY4Mzc1NywianRpIjoiZDkzNzQ4NDEtNmVkYi00Zjc5LTgzMWQtOWVmOTBiMDMxNGUzIn0.nN0dePrkPGBaiHK34KXeb1hHTAflSMmqDTKZbXfWSoVUXH17bF5KtEuAunwuS8pO84aga3FlkClbH6W8W21KLmeOtccSAFl2lIqTzaMMD_VgwuXw99Pwj2C2qAelnROJxSG35tpJQTtd960ZY6DxUp6XlYlu-n_3oNrpLpTfYMnDV3h6i0M5P2L4wb6P8BV-xnDTbMZrEZRb7O4k26aeJvGuByFwzy4SGxHPSa4tHY-iIvo8wPMAJhCqebo_cy2Edjs-KvEi5KbRhB3WmADv8Dfm7BzxIN4xv_Miulo372tIGDyXdeL3t-2aE9CxeAR9Ruu_ovPyUhEOtCYmOwdSLQ
>> request before interceptors >> content-type: application/json
>> request before interceptors >> content-length: 23
>> request before interceptors >> x-forwarded-proto: https
>> request before interceptors >> x-request-id: 57832b70-446b-9945-9d63-1ceb3be51734
{"name":"The Prisoner"}
[2022-04-11 13:29:19.539][14][debug][lua] [source/extensions/filters/common/lua/lua.cc:39] coroutine finished
[2022-04-11 13:29:19.539][14][debug][lua] [source/extensions/filters/common/lua/lua.cc:39] coroutine finished
[2022-04-11 13:29:19.539][14][debug][lua] [source/extensions/filters/http/lua/lua_filter.cc:470] yielding for full body
[2022-04-11 13:29:19.539][14][debug][lua] [source/extensions/filters/common/lua/lua.cc:42] coroutine yielded
[2022-04-11 13:29:19.539][14][debug][lua] [source/extensions/filters/http/lua/lua_filter.cc:231] resuming body due to end stream
[2022-04-11 13:29:19.539][14][debug][lua] [source/extensions/filters/http/lua/lua_filter.cc:792] script log: 
>> request after interceptors >> :authority: localhost:9095
>> request after interceptors >> :path: /book-store/v1/books
>> request after interceptors >> :method: POST
>> request after interceptors >> :scheme: https
>> request after interceptors >> user-agent: curl/7.68.0
>> request after interceptors >> accept: */*
>> request after interceptors >> authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik1UWm1ZemsxWlRJeVkyTmlNR00wT1RJMFpqTXdNRE5rTldZek16QTJOVEl4TWpRelpERTFNdz09In0.eyJhdWQiOiJodHRwOlwvXC9vcmcud3NvMi5hcGltZ3RcL2dhdGV3YXkiLCJzdWIiOiJhZG1pbiIsInNjb3BlIjoicmVhZDpwZXRzIiwiaXNzIjoiaHR0cHM6XC9cL2xvY2FsaG9zdDo5MDk1XC90ZXN0a2V5Iiwia2V5dHlwZSI6IlBST0RVQ1RJT04iLCJleHAiOjE2NDk2ODczNTcsImlhdCI6MTY0OTY4Mzc1NywianRpIjoiZDkzNzQ4NDEtNmVkYi00Zjc5LTgzMWQtOWVmOTBiMDMxNGUzIn0.nN0dePrkPGBaiHK34KXeb1hHTAflSMmqDTKZbXfWSoVUXH17bF5KtEuAunwuS8pO84aga3FlkClbH6W8W21KLmeOtccSAFl2lIqTzaMMD_VgwuXw99Pwj2C2qAelnROJxSG35tpJQTtd960ZY6DxUp6XlYlu-n_3oNrpLpTfYMnDV3h6i0M5P2L4wb6P8BV-xnDTbMZrEZRb7O4k26aeJvGuByFwzy4SGxHPSa4tHY-iIvo8wPMAJhCqebo_cy2Edjs-KvEi5KbRhB3WmADv8Dfm7BzxIN4xv_Miulo372tIGDyXdeL3t-2aE9CxeAR9Ruu_ovPyUhEOtCYmOwdSLQ
>> request after interceptors >> content-type: application/json
>> request after interceptors >> content-length: 23
>> request after interceptors >> x-forwarded-proto: https
>> request after interceptors >> x-request-id: 57832b70-446b-9945-9d63-1ceb3be51734
{"name":"The Prisoner"}
[2022-04-11 13:29:19.539][14][debug][lua] [source/extensions/filters/common/lua/lua.cc:39] coroutine finished
[2022-04-11 13:29:19.539][14][debug][http] [source/common/http/filter_manager.cc:953] [C12][S11928103386873881598] Sending local reply with details route_not_found
[2022-04-11 13:29:19.539][14][debug][lua] [source/extensions/filters/http/lua/lua_filter.cc:470] yielding for full body
[2022-04-11 13:29:19.539][14][debug][lua] [source/extensions/filters/common/lua/lua.cc:42] coroutine yielded
[2022-04-11 13:29:19.539][14][debug][lua] [source/extensions/filters/http/lua/lua_filter.cc:231] resuming body due to end stream
[2022-04-11 13:29:19.539][14][debug][lua] [source/extensions/filters/http/lua/lua_filter.cc:792] script log: 
<< response before interceptors << :status: 404
<< response before interceptors << content-length: 94
<< response before interceptors << content-type: application/json
{"code":"404","message":"Not Found","description":"The requested resource is not available."}
[2022-04-11 13:29:19.539][14][debug][lua] [source/extensions/filters/common/lua/lua.cc:39] coroutine finished
[2022-04-11 13:29:19.539][14][debug][lua] [source/extensions/filters/common/lua/lua.cc:39] coroutine finished
[2022-04-11 13:29:19.539][14][debug][lua] [source/extensions/filters/http/lua/lua_filter.cc:470] yielding for full body
[2022-04-11 13:29:19.539][14][debug][lua] [source/extensions/filters/common/lua/lua.cc:42] coroutine yielded
[2022-04-11 13:29:19.539][14][debug][lua] [source/extensions/filters/http/lua/lua_filter.cc:231] resuming body due to end stream
[2022-04-11 13:29:19.539][14][debug][lua] [source/extensions/filters/http/lua/lua_filter.cc:792] script log: 
<< response after interceptors << :status: 404
<< response after interceptors << content-length: 94
<< response after interceptors << content-type: application/json
{"code":"404","message":"Not Found","description":"The requested resource is not available."}
```